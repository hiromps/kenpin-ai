# デバッグガイド - 欠陥検出が動作しない場合

## 問題: サンプルと同じ画像をスキャンしてもトースト表示されない

### デバッグ手順

#### 1. ブラウザのコンソールを開く

**iPhone Safari:**
1. 設定 → Safari → 詳細 → Webインスペクタ をオンにする
2. MacでSafariを開く → 開発 → iPhoneの名前 → サイトを選択

**デスクトップブラウザ:**
- Chrome/Edge: F12キーまたは右クリック → 検証
- Firefox: F12キーまたは右クリック → 要素を調査

#### 2. コンソールログを確認

スキャン中に以下のログが表示されます：

```
Pixel analysis: {darkSpots: 123, brightness: 145, irregularity: 45}
Checking against 2 黒点 samples
Similarity breakdown: {histogram: "0.423", pixel: "0.567", edge: "0.345", total: "0.456"}
黒点 similarity: 0.456 isSimilar: false
✓ No defects detected
```

#### 3. ログから問題を特定

**ケース1: サンプル数が0**
```
Checking against 0 黒点 samples
```
→ サンプルが登録されていません。サンプル管理から画像を登録してください。

**ケース2: 類似度が低い**
```
黒点 similarity: 0.456 isSimilar: false
```
→ 類似度が閾値（0.5）未満です。以下を確認：
- サンプル画像と検査対象が本当に同じですか？
- サンプル画像は欠陥部分を明確に捉えていますか？
- 照明条件が大きく異なっていませんか？

**ケース3: Pixel analysis値が極端**
```
Pixel analysis: {darkSpots: 0, brightness: 200, irregularity: 5}
```
→ 画像が明るすぎるか、欠陥が小さすぎます：
- カメラを欠陥部分に近づける
- 照明を調整する
- より大きな欠陥のサンプルを登録する

#### 4. 類似度の内訳を確認

```
Similarity breakdown: {
  histogram: "0.423",  // 色分布の類似度
  pixel: "0.567",      // ピクセル差分の類似度
  edge: "0.345",       // エッジの類似度
  total: "0.456"       // 総合類似度（閾値: 0.5）
}
```

- **total < 0.5**: 検出されません
- **total >= 0.5**: 検出されます

#### 5. 改善方法

**類似度が低い場合:**

1. **サンプル画像を改善**
   - 欠陥部分をクローズアップで撮影
   - 明確な欠陥が写っている画像を使用
   - 複数の角度からサンプルを登録

2. **検査条件を調整**
   - カメラを欠陥に近づける
   - 照明を一定にする
   - オブジェクトをゆっくり回転させる

3. **複数サンプルを登録**
   - 同じ欠陥タイプで複数のサンプルを登録
   - 最大類似度が使用されるため、精度向上

## 類似度の調整（開発者向け）

`src/utils/imageAnalysis.ts` の以下の部分で閾値を調整できます：

```typescript
const { isSimilar, maxSimilarity } = await findSimilarSample(
  imageDataUrl,
  darkSpotSamples,
  0.5 // ← この値を変更（0.0〜1.0）
);
```

- **0.3〜0.4**: かなり緩い（誤検出のリスク高）
- **0.5**: デフォルト（バランス型）
- **0.6〜0.7**: 厳しい（検出漏れのリスク高）

## よくある問題

### Q: サンプルを登録したのに検出されない

**A:** 以下を確認：
1. コンソールで「Checking against X samples」が表示されるか
2. 類似度（similarity）の値が0.5以上か
3. サンプル画像と検査画像の照明条件が近いか

### Q: 類似度が常に低い（0.2以下）

**A:** 画像が全く異なっています：
1. サンプル画像を確認（正しく登録されているか）
2. カメラの向きや角度を調整
3. 欠陥部分が画面中央にあるか確認

### Q: 欠陥がないのに検出される（誤検出）

**A:** 類似度閾値が低すぎます：
1. サンプル画像を見直す（明確な欠陥のみ）
2. 閾値を0.6〜0.7に上げる
3. 不要なサンプルを削除

## サポート

問題が解決しない場合は、以下の情報を提供してください：
- コンソールログのスクリーンショット
- サンプル画像
- 検査対象の画像
- 類似度の値
